<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <style>
    html, body, .main {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .btn {
      margin: 10% auto 5% auto;
      text-align: center;
      vertical-align: middle;
    }

    .btn button {
      width: 70%;
      font-size: 50px;
      border: 1px solid;
      margin: 20px auto;
    }

    .log {
      border: 3px dashed gray;
      padding: 2%;
      margin: 0 5%;
      min-height: 70%;
    }

    .log div {
      font-size: 3vw;
      border-bottom: 1px solid #ddd;
      padding: 10px 15px;
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="btn"></div>
    <div class="log"></div>
  </div>
<script>

  let config = {};
  try {
    config = JSON.parse(window.location.hash.length > 1 ? decodeURIComponent(window.location.hash.substring(1)) : '{}');
  } catch (e) {
    console.log(' > Config parsing failure, downgrading to bundle');
    config = {
      domain: "connect.pruno.sb.facebook.com",
      fbid: '384481185065935',
      fbqq: 'v=next&no_min',
      appid: '1234038296672681'
    };
  }

  console.log(' > Loaded config:');
  console.log(config);

  class Bridge {

    getProtocol() {
      return 'fbmq-0.1';
    }

    sendEvent(pixelID, evtName, customData) {
      console.log('FBMQ mock-track: [' + pixelID + ' -> ' + config.appid + ']', evtName, JSON.stringify(customData));
      this.clear();
    }
  }

  const log = (msg) => {
    const entry = document.createElement('div');
    entry.innerHTML = '> ' + msg;
    const canvas = document.querySelector('.log');
    canvas.insertBefore(entry, canvas.firstChild);
  };

  const onClick = (evtName, payload) => {
    const date = (new Date());
    const base = { timestamp: Math.round(date.getTime() / 1000) };
    const evt = [evtName, Object.assign({}, payload, base)];
    fbq('trackCustom', evt[0], evt[1]);
    log('[' + date.toString() + '] ' + evt[0]);
  };


  const makeBtn = (txt) => {
    const body = document.body;
    const btn = document.createElement('button');
    btn.innerHTML = txt;
    document.querySelector('.btn').appendChild(btn);
    return btn;
  };

  const makeEvtBtn = (txt, evtName, payload) => {
    const btn = makeBtn(txt);
    btn.addEventListener('click', () => onClick.call(this, evtName, payload));
    return btn;
  };

  const makeSingleUseBtn = (txt, callback) => {
    const btn = makeBtn(txt);
    btn.addEventListener('click', () => {
      btn.disabled = true;
      callback.call(btn);
    }, { once: true });
    return btn;
  };

  const onInjectClick = () => {
    if (config.appid) {
      window['fbmq_' + config.appid] = new Bridge();
    } else {
      console.error(' ERR: invalid config ');
    }
  };

  const onEnableClick = () => {
    if (config.fbid && config.appid) {
      fbq('set', 'mobileBridge', config.fbid.toString(), config.appid.toString());
      console.log(' > Mobile bridge authorized as ' + config.fbid + ' -> ' + config.appid);
    } else {
      console.error(' ERR: invalid config ');
    }
  };

  const staticBinding = config.appid && window['fbmq_' + config.appid];

  window.addEventListener('load', () => {
    if (staticBinding) {
      const btn = makeSingleUseBtn('Detected External Binding', () => {});
      btn.disabled = true;
    } else {
      makeSingleUseBtn('Inject Local Binding', onInjectClick);
    }
    makeSingleUseBtn('Enable Binding', onEnableClick);
    makeEvtBtn('Fire Standard', 'Search');
    makeEvtBtn('Fire Custom', 'fbq_probe');
    makeEvtBtn('Fire 自定义事件', 'fbq_chinese_probe', { payload: '自定义事件' });
  });

  let fbqu = 'https://'
    + (config.domain || 'connect.facebook.net')
    + '/en_US/fbevents.js?'
    + (config.fbqq || '');

  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script',fbqu);

  config.fbid && fbq('init', config.fbid.toString());

</script>
</body>
</html>
